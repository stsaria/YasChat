# YasChat NETWORK
## 基本
YasChatのネットワークはP2Pで構成されています。

自分のStunIPを取得し、ブートストラップノードに取得したStunIPを送ります。(ブートストラップノードはそのIPをリストに保存して、定期的にそのIPにたどれるかをチェックします。)

そして、利用できるNATの種類はRestricted ConeとFull Coneです。
※Restricted Cone NAT状態は利用できますが、多くのチャットを読み込む可能性が低くなります。

## データのサイズ
- 一つのチャット(世の中ではスレッドと呼ばれますが)の全体サイズは2MB以下です。(これを守らないと、チャットを受け付けません)
    その上でチャットのすべてのメッセージ数は合計で500以下ぐらいが望ましいでしょう。
    それと、1メッセージの最大バイト数は3KB以下ぐらいが望ましいでしょう。
    2MBというのはあくまで最大のサイズなので、1KBでも問題ありません。

## プロトコル
### すべてに適するもの
ピアやノードとの通信では、辞書型データのUTF-8文字列をBase64でエンコードしたバイト列を送受信します。
実際に送信するプロトコルの詳細は以下の通りです。
※大文字小文字は区別されます
``` json
{
    "m":"モード(p,r,c,s,R)",
    // その次はモードごとに異なる
}
```
### p(ping)
相手のコンピュータとの疎通確認
``` json
{
    "m":"p"
}
```
### r(request)
リクエスト(取得のため、登録のため)
``` json
{
    "m":"r",
    "t":"リクエストタイプ(g,r)",
    "d":"内容のタイプ(c,p,i)",
    "a":{ 
        // 引数(内容によって異なる)
    }
}
```
#### g(get)
他の人の情報を取得します(ピアまたはブートストラップノードへ)
##### c(chats)
チャットリストをリクエストします。(チャットの名前は含まない)
``` json
{
    "m":"r",
    "t":"g",
    "d":"c",
    "a":{
        "maxChatsLength":受信可能なチャットの長さ,
    }
}
```
##### m(messages)
チャット内にあるメッセージをリクエストします。(チャットの名前は含まない)
``` json
{
    "m":"r",
    "t":"g",
    "d":"m",
    "a":{
        "chatUuid":"チャットのUUID",
    }
}
```
##### i(information)
ピア情報を他のピアまたはブートストラップノードから取得します
``` json
{
    "m":"g",
    "t":"r",
    "d":"i",
    "a":{
        "maxPeersLength":受信可能なチャットの長さ,
    }
}
```
ネットワーク識別子(n)はそのチャットのネットワークIDを事前に知っておく必要があります。
#### r(register)
自分の情報を登録します(ブートストラップノードへ)
##### i(information)
自分のピア情報をブートストラップノードまたはピアに登録します。
これはネットワークに参加するはじめの一歩でもあります！！！
``` json
{
    "m":"r",
    "t":"r",
    "d":"i",
    "a":{
        "natConeType":"自分のNAT状況(文字列)(Restricted ConeまたはFull Cone)",
        "stunIp":"ピアリストに使われるStunIp(文字列)",
        "stunPort":ピアリストに使われるStunPort(整数),
        "sourcePort":サーバー自体のポート
    }
}
```
ネットワーク識別子(n)はそのチャットのネットワークIDを事前に知っておく必要があります。

### R(response)
リクエストなどを送信した場合に帰ってくるレスポンスです。
``` json
{
    "m":"R",
    "r":結果(整数　0は成功　それ以外はエラー),
    "c":{ 
        // レスポンスの内容
    }
}
```
#### 結果が0の場合
0の場合はそのリクエストが成功したときです。
##### レスポンスの内容
- チャットリスト
    ``` json
    {
        "m":"R",
        "r":0,
        "c":{ 
            "chats":[
                {"uuid":"チャット固有のUUID", "name":"チャット名", "timestamp":"タイムスタンプ"}
            ]
        }
    }
    ```
- メッセージリスト
    ``` json
    {
        "m":"R",
        "r":0,
        "c":{ 
            "messages":[
                {"uuid":"メッセージ固有のUUID", "name":"名前", "content":"メッセージ内容", "timestamp":"タイムスタンプ"}
            ]
        }
    }
    ```
- ピア情報取得
    ``` json
    {
        "m":"R",
        "r":0,
        "c":{ 
            "peers":[
                {"natConeType":"NATのタイプ(Restricted ConeまたはFull Cone)", "stunIp":"相手のStunIP", "stunPort":"相手のStunPort"}
            ]
        }
    }
    ```
- ピア情報登録(ブートストラップノードから返されるレスポンス)
    ``` json
    {
        "m":"R",
        "r":0,
        "c":{}
    }
    ```
- ping
    ``` json
    {
        "m":"R",
        "r":0,
        "c":{}
    }
    ```
#### 結果が0以外(エラーの場合)
エラーの場合は以下のようになります。
``` json
{
    "m":"R",
    "r":エラーコード(1以外の整数),
    "c":{}
}
```
##### エラーコード
###### 0番台
- 1 : 例外が発生しました
- 2 : 不明なフォーマット
- 3 : あなたにアクセスすることができません
###### 10番台(get)
- 10 : 指定されたものはありません